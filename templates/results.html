{% extends "base.html" %}

{% block content %}
{% if search_results %}
<div class="section-toggle">
    <button type="button" class="toggle-button active" data-target="videos-section">Videos</button>
    <button type="button" class="toggle-button" data-target="images-section">Images</button>
</div>
<div class="result-card">
    <div id="videos-section">
        <h3>Videos</h3>
        <div class="grid" id="search-grid">
            {% for emote in search_results if emote.is_animated %}
            <div class="result-item">
                <div class="name">{{ emote.name }}</div>
                {% if emote.image %}
                <img src="{{ emote.image.url }}" alt="{{ emote.name }}" />
                <form method="post" action="/convert">
                    <input type="hidden" name="emote_url" value="{{ emote.image.url }}" />
        <button type="submit">Convert</button>
                </form>
                {% else %}
        <div class="tip">No image available</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="section-hidden" id="images-section">
        <h3>Images</h3>
        <div class="grid" id="static-grid">
            {% for emote in search_results if not emote.is_animated %}
            <div class="result-item">
                <div class="name">{{ emote.name }}</div>
                {% if emote.static_image %}
                <img src="{{ emote.static_image.url }}" alt="{{ emote.name }}" />
                <form method="get" action="/download-image">
                    <input type="hidden" name="url" value="{{ emote.static_image.url }}" />
                <button type="submit" class="download-button">Download PNG</button>
                </form>
                {% else %}
            <div class="tip">No image available</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="loading-container" id="scroll-status" data-page="{{ search_page or 1 }}"
        data-query="{{ search_query or '' }}">
        <div class="spinner" aria-hidden="true"></div>
        <div class="spinner-text">Loading more...</div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    (function () {
        const status = document.getElementById("scroll-status");
        const animatedGrid = document.getElementById("search-grid");
        const staticGrid = document.getElementById("static-grid");
        if (!status || !animatedGrid || !staticGrid) {
            return;
        }

        let page = parseInt(status.dataset.page || "1", 10);
        const query = status.dataset.query || "";
        let loading = false;
        let done = false;

        async function loadMore() {
            if (loading || done) {
                return;
            }
            loading = true;
            status.classList.remove("is-done", "is-error");
        status.querySelector(".spinner-text").textContent = "Loading more...";
            const nextPage = page + 1;
            try {
                const response = await fetch(
                    `/search/page?emote_name=${encodeURIComponent(query)}&page=${nextPage}`
                );
                if (!response.ok) {
                    throw new Error("search failed");
                }
                const data = await response.json();
                const animatedItems = data.animated_items || [];
                const staticItems = data.static_items || [];
                if (animatedItems.length === 0 && staticItems.length === 0) {
                    done = true;
                    status.classList.add("is-done");
        status.querySelector(".spinner-text").textContent = "No more results";
                    return;
                }
                animatedItems.forEach((item) => {
                    const wrapper = document.createElement("div");
                    wrapper.className = "result-item";

                    const name = document.createElement("div");
                    name.className = "name";
                    name.textContent = item.name;
                    wrapper.appendChild(name);

                    if (item.image_url) {
                        const img = document.createElement("img");
                        img.src = item.image_url;
                        img.alt = item.name;
                        wrapper.appendChild(img);

                        const form = document.createElement("form");
                        form.method = "post";
                        form.action = "/convert";
                        const hidden = document.createElement("input");
                        hidden.type = "hidden";
                        hidden.name = "emote_url";
                        hidden.value = item.image_url;
                        form.appendChild(hidden);
                        const button = document.createElement("button");
                        button.type = "submit";
                        button.textContent = "Convert";
                        form.appendChild(button);
                        wrapper.appendChild(form);
                    } else {
                        const tip = document.createElement("div");
                        tip.className = "tip";
                        tip.textContent = "No image available";
                        wrapper.appendChild(tip);
                    }

                    animatedGrid.appendChild(wrapper);
                });
                staticItems.forEach((item) => {
                    const wrapper = document.createElement("div");
                    wrapper.className = "result-item";

                    const name = document.createElement("div");
                    name.className = "name";
                    name.textContent = item.name;
                    wrapper.appendChild(name);

                    const previewUrl = item.png_url || item.image_url;
                    if (previewUrl) {
                        const img = document.createElement("img");
                        img.src = previewUrl;
                        img.alt = item.name;
                        wrapper.appendChild(img);

                        const form = document.createElement("form");
                        form.method = "get";
                        form.action = "/download-image";

                        const hidden = document.createElement("input");
                        hidden.type = "hidden";
                        hidden.name = "url";
                        hidden.value = previewUrl;
                        form.appendChild(hidden);

                        const button = document.createElement("button");
                        button.type = "submit";
                        button.className = "download-button";
                        button.textContent = item.png_url ? "Download PNG" : "Download";
                        form.appendChild(button);

                        wrapper.appendChild(form);
                    } else {
                        const tip = document.createElement("div");
                        tip.className = "tip";
                        tip.textContent = "No image available";
                        wrapper.appendChild(tip);
                    }

                    staticGrid.appendChild(wrapper);
                });
                page = nextPage;
                status.dataset.page = String(page);
            } catch (err) {
                status.classList.add("is-error");
            status.querySelector(".spinner-text").textContent = "Error loading results";
            } finally {
                loading = false;
            }
        }

        const scrollRoot = document.querySelector(".panel");
        const observer = new IntersectionObserver((entries) => {
            if (entries.some((entry) => entry.isIntersecting)) {
                loadMore();
            }
        }, scrollRoot ? { root: scrollRoot } : undefined);
        observer.observe(status);
    })();

    (function () {
        const toggleButtons = document.querySelectorAll(".toggle-button");
        const videosSection = document.getElementById("videos-section");
        const imagesSection = document.getElementById("images-section");
        if (!toggleButtons.length || !videosSection || !imagesSection) {
            return;
        }

        toggleButtons.forEach((button) => {
            button.addEventListener("click", () => {
                toggleButtons.forEach((btn) => btn.classList.remove("active"));
                button.classList.add("active");
                if (button.dataset.target === "images-section") {
                    videosSection.classList.add("section-hidden");
                    imagesSection.classList.remove("section-hidden");
                } else {
                    imagesSection.classList.add("section-hidden");
                    videosSection.classList.remove("section-hidden");
                }
            });
        });
    })();

    (function () {
        const forms = document.querySelectorAll("form[action='/convert']");
        if (!forms.length) {
            return;
        }

        forms.forEach((form) => {
            form.addEventListener("submit", () => {
                const button = form.querySelector("button");
                if (!button) {
                    return;
                }
                button.disabled = true;
                button.classList.add("btn-loading");
                button.innerHTML = '<span class="btn-spinner" aria-hidden="true"></span><span>Converting...</span>';
            });
        });
    })();
</script>
{% endblock %}
