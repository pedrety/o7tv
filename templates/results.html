{% extends "base.html" %}

{% block content %}
{% if search_results %}
<div class="flex gap-2.5 flex-col sm:flex-row">
    <button type="button"
        class="flex-1 px-3 py-2.5 rounded-[10px] border border-white/[0.08] bg-[linear-gradient(120deg,#c15dff_0%,#d296fa_100%)] text-[#001019] font-semibold cursor-pointer border-transparent"
        data-target="videos-section">Videos</button>
    <button type="button"
        class="flex-1 px-3 py-2.5 rounded-[10px] border border-white/[0.08] bg-white/[0.04] text-[#eef1f4] font-semibold cursor-pointer"
        data-target="images-section">Images</button>
</div>
<div
    class="border border-white/[0.06] rounded-[12px] bg-white/[0.02] p-3.5 flex flex-col items-stretch text-center flex-1 min-h-0 overflow-y-auto overflow-x-hidden overscroll-contain [-webkit-overflow-scrolling:touch]">
    <div id="videos-section">
        <h3 class="m-0 mb-2.5 text-[15px] text-[#a2a9b0]">Videos</h3>
        <div class="w-full grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 mt-3" id="search-grid">
            {% for emote in search_results if emote.is_animated %}
            <div
                class="p-2.5 rounded-[12px] bg-white/[0.03] border border-white/[0.06] flex flex-col items-center gap-2">
                <div class="text-xs text-[#a2a9b0] break-words">{{ emote.name }}</div>
                {% if emote.image %}
                <img src="{{ emote.image.url }}" alt="{{ emote.name }}"
                    class="w-[120px] h-[120px] sm:w-[140px] sm:h-[140px] object-contain" />
                <form method="post" action="/convert"
                    class="m-0 p-0 border-0 bg-transparent w-auto inline-flex items-center justify-center">
                    <input type="hidden" name="emote_url" value="{{ emote.image.url }}" />
                    <button type="submit"
                        class="px-3 py-2 text-[13px] rounded-[10px] bg-[linear-gradient(120deg,#c15dff_0%,#d296fa_100%)] text-[#001019] font-bold shadow-[0_6px_18px_rgba(108,255,255,0.2)] transition active:translate-y-[1px]">Convert</button>
                </form>
                {% else %}
                <div class="text-[#a2a9b0] text-xs mt-[-2px]">No image available</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="hidden" id="images-section">
        <h3 class="m-0 mb-2.5 text-[15px] text-[#a2a9b0]">Images</h3>
        <div class="w-full grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 mt-3" id="static-grid">
            {% for emote in search_results if not emote.is_animated %}
            <div
                class="p-2.5 rounded-[12px] bg-white/[0.03] border border-white/[0.06] flex flex-col items-center gap-2">
                <div class="text-xs text-[#a2a9b0] break-words">{{ emote.name }}</div>
                {% if emote.static_image %}
                <img src="{{ emote.static_image.url }}" alt="{{ emote.name }}"
                    class="w-[120px] h-[120px] sm:w-[140px] sm:h-[140px] object-contain" />
                <form method="get" action="/download-image"
                    class="m-0 p-0 border-0 bg-transparent w-auto inline-flex items-center justify-center">
                    <input type="hidden" name="url" value="{{ emote.static_image.url }}" />
                    <button type="submit"
                        class="px-3 py-2 text-[13px] rounded-[10px] bg-[linear-gradient(120deg,#c15dff_0%,#d296fa_100%)] text-[#001019] font-bold shadow-[0_6px_18px_rgba(108,255,255,0.2)] transition active:translate-y-[1px]">Download
                        PNG</button>
                </form>
                {% else %}
                <div class="text-[#a2a9b0] text-xs mt-[-2px]">No image available</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="w-full flex items-center justify-center gap-3 py-5 pb-1.5 text-[#a2a9b0] text-sm" id="scroll-status"
        data-page="{{ search_page or 1 }}" data-query="{{ search_query or '' }}">
        <div class="w-11 h-11 rounded-full border-4 border-white/[0.12] border-l-[#c15dff] animate-spin status-spinner"
            aria-hidden="true"></div>
        <div class="text-sm status-text">Loading more...</div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    (function () {
        const status = document.getElementById("scroll-status");
        const animatedGrid = document.getElementById("search-grid");
        const staticGrid = document.getElementById("static-grid");
        if (!status || !animatedGrid || !staticGrid) {
            return;
        }

        let page = parseInt(status.dataset.page || "1", 10);
        const query = status.dataset.query || "";
        let loading = false;
        let done = false;

        async function loadMore() {
            if (loading || done) {
                return;
            }
            loading = true;
            status.dataset.state = "loading";
            const statusText = status.querySelector(".status-text");
            const spinner = status.querySelector(".status-spinner");
            if (spinner) {
                spinner.classList.remove("hidden");
            }
            if (statusText) {
                statusText.textContent = "Loading more...";
            }
            const nextPage = page + 1;
            try {
                const response = await fetch(
                    `/search/page?emote_name=${encodeURIComponent(query)}&page=${nextPage}`
                );
                if (!response.ok) {
                    throw new Error("search failed");
                }
                const data = await response.json();
                const animatedItems = data.animated_items || [];
                const staticItems = data.static_items || [];
                if (animatedItems.length === 0 && staticItems.length === 0) {
                    done = true;
                    status.dataset.state = "done";
                    if (spinner) {
                        spinner.classList.add("hidden");
                    }
                    const doneText = status.querySelector(".status-text");
                    if (doneText) {
                        doneText.textContent = "No more results";
                    }
                    return;
                }
                animatedItems.forEach((item) => {
                    const wrapper = document.createElement("div");
                    wrapper.className =
                        "p-2.5 rounded-[12px] bg-white/[0.03] border border-white/[0.06] flex flex-col items-center gap-2";

                    const name = document.createElement("div");
                    name.className = "text-xs text-[#a2a9b0] break-words";
                    name.textContent = item.name;
                    wrapper.appendChild(name);

                    if (item.image_url) {
                        const img = document.createElement("img");
                        img.src = item.image_url;
                        img.alt = item.name;
                        img.className =
                            "w-[120px] h-[120px] sm:w-[140px] sm:h-[140px] object-contain";
                        wrapper.appendChild(img);

                        const form = document.createElement("form");
                        form.method = "post";
                        form.action = "/convert";
                        form.className =
                            "m-0 p-0 border-0 bg-transparent w-auto inline-flex items-center justify-center";
                        const hidden = document.createElement("input");
                        hidden.type = "hidden";
                        hidden.name = "emote_url";
                        hidden.value = item.image_url;
                        form.appendChild(hidden);
                        const button = document.createElement("button");
                        button.type = "submit";
                        button.className =
                            "px-3 py-2 text-[13px] rounded-[10px] bg-[linear-gradient(120deg,#c15dff_0%,#d296fa_100%)] text-[#001019] font-bold shadow-[0_6px_18px_rgba(108,255,255,0.2)] transition active:translate-y-[1px]";
                        button.textContent = "Convert";
                        form.appendChild(button);
                        wrapper.appendChild(form);
                    } else {
                        const tip = document.createElement("div");
                        tip.className = "text-[#a2a9b0] text-xs mt-[-2px]";
                        tip.textContent = "No image available";
                        wrapper.appendChild(tip);
                    }

                    animatedGrid.appendChild(wrapper);
                });
                staticItems.forEach((item) => {
                    const wrapper = document.createElement("div");
                    wrapper.className =
                        "p-2.5 rounded-[12px] bg-white/[0.03] border border-white/[0.06] flex flex-col items-center gap-2";

                    const name = document.createElement("div");
                    name.className = "text-xs text-[#a2a9b0] break-words";
                    name.textContent = item.name;
                    wrapper.appendChild(name);

                    const previewUrl = item.png_url || item.image_url;
                    if (previewUrl) {
                        const img = document.createElement("img");
                        img.src = previewUrl;
                        img.alt = item.name;
                        img.className =
                            "w-[120px] h-[120px] sm:w-[140px] sm:h-[140px] object-contain";
                        wrapper.appendChild(img);

                        const form = document.createElement("form");
                        form.method = "get";
                        form.action = "/download-image";
                        form.className =
                            "m-0 p-0 border-0 bg-transparent w-auto inline-flex items-center justify-center";

                        const hidden = document.createElement("input");
                        hidden.type = "hidden";
                        hidden.name = "url";
                        hidden.value = previewUrl;
                        form.appendChild(hidden);

                        const button = document.createElement("button");
                        button.type = "submit";
                        button.className =
                            "px-3 py-2 text-[13px] rounded-[10px] bg-[linear-gradient(120deg,#c15dff_0%,#d296fa_100%)] text-[#001019] font-bold shadow-[0_6px_18px_rgba(108,255,255,0.2)] transition active:translate-y-[1px]";
                        button.textContent = item.png_url ? "Download PNG" : "Download";
                        form.appendChild(button);

                        wrapper.appendChild(form);
                    } else {
                        const tip = document.createElement("div");
                        tip.className = "text-[#a2a9b0] text-xs mt-[-2px]";
                        tip.textContent = "No image available";
                        wrapper.appendChild(tip);
                    }

                    staticGrid.appendChild(wrapper);
                });
                page = nextPage;
                status.dataset.page = String(page);
            } catch (err) {
                status.dataset.state = "error";
                if (spinner) {
                    spinner.classList.add("hidden");
                }
                const errorText = status.querySelector(".status-text");
                if (errorText) {
                    errorText.textContent = "Error loading results";
                }
            } finally {
                loading = false;
            }
        }

        const scrollRoot = document.querySelector("main");
        const observer = new IntersectionObserver((entries) => {
            if (entries.some((entry) => entry.isIntersecting)) {
                loadMore();
            }
        }, scrollRoot ? { root: scrollRoot } : undefined);
        observer.observe(status);
    })();

    (function () {
        const toggleButtons = document.querySelectorAll("[data-target]");
        const videosSection = document.getElementById("videos-section");
        const imagesSection = document.getElementById("images-section");
        if (!toggleButtons.length || !videosSection || !imagesSection) {
            return;
        }

        toggleButtons.forEach((button) => {
            button.addEventListener("click", () => {
                toggleButtons.forEach((btn) => {
                    btn.classList.remove(
                        "bg-[linear-gradient(120deg,#c15dff_0%,#d296fa_100%)]",
                        "text-[#001019]",
                        "border-transparent"
                    );
                    btn.classList.add(
                        "bg-white/[0.04]",
                        "border-white/[0.08]",
                        "text-[#eef1f4]"
                    );
                });
                button.classList.remove(
                    "bg-white/[0.04]",
                    "border-white/[0.08]",
                    "text-[#eef1f4]"
                );
                button.classList.add(
                    "bg-[linear-gradient(120deg,#c15dff_0%,#d296fa_100%)]",
                    "text-[#001019]",
                    "border-transparent"
                );
                if (button.dataset.target === "images-section") {
                    videosSection.classList.add("hidden");
                    imagesSection.classList.remove("hidden");
                } else {
                    imagesSection.classList.add("hidden");
                    videosSection.classList.remove("hidden");
                }
            });
        });
    })();

    (function () {
        const forms = document.querySelectorAll("form[action='/convert']");
        if (!forms.length) {
            return;
        }

        forms.forEach((form) => {
            form.addEventListener("submit", () => {
                const button = form.querySelector("button");
                if (!button) {
                    return;
                }
                button.disabled = true;
                button.classList.add(
                    "inline-flex",
                    "items-center",
                    "justify-center",
                    "gap-2",
                    "opacity-85",
                    "cursor-wait"
                );
                button.innerHTML =
                    '<span class="w-4 h-4 rounded-full border-2 border-[rgba(0,16,25,0.2)] border-l-[#001019] animate-spin" aria-hidden="true"></span><span>Converting...</span>';
            });
        });
    })();
</script>
{% endblock %}